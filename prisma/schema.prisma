generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTH & USERS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  phone         String?
  password      String?
  image         String?
  role          UserRole  @default(PROPRIETAR)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]

  // Admin relations
  asociatiiAdmin Asociatie[] @relation("AdminAsociatie")

  // Proprietar relations
  apartamente   ProprietarApartament[]
  plati         Plata[]
  notificari    Notificare[]

  // AI Agent activity
  agentLogs     AgentLog[]

  // Tichete
  ticheteCreate    Tichet[]           @relation("TicheteCreate")
  ticheteAsignate  Tichet[]           @relation("TicheteAsignate")
  comentariiTichet ComentariuTichet[]

  // Invitations sent
  invitationsSent  InvitationToken[]

  // Multi-tenant: membership în organizații
  organizatii      UtilizatorOrganizatie[]

  // Import sessions
  importSessions   ImportSession[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@map("password_reset_tokens")
}

model InvitationToken {
  id            String   @id @default(cuid())
  email         String
  token         String   @unique
  expires       DateTime
  createdAt     DateTime @default(now())
  usedAt        DateTime?

  // Link to association
  asociatieId   String
  asociatie     Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  // Optional: pre-assign to specific apartment
  apartamentId  String?
  apartament    Apartament? @relation(fields: [apartamentId], references: [id], onDelete: SetNull)

  // Name of invited person (optional)
  numeInvitat   String?

  // Who sent the invitation
  invitedById   String
  invitedBy     User     @relation(fields: [invitedById], references: [id])

  @@index([email])
  @@index([asociatieId])
  @@map("invitation_tokens")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PROPRIETAR
}

// ============================================
// ASOCIATIE & BLOC
// ============================================

model Asociatie {
  id              String   @id @default(cuid())
  nume            String
  cui             String?  @unique
  adresa          String
  oras            String
  judet           String
  codPostal       String?

  // Contact
  email           String?
  telefon         String?

  // Financiar
  contBancar      String?
  banca           String?

  // Settings
  ziScadenta      Int      @default(25)
  penalizareZi    Float    @default(0.02) // 0.02% pe zi

  // Chitanțier (Receipt Book)
  serieChitantier       String?   // ex: "CHT", "ABC"
  numarChitantierStart  Int       @default(1)
  ultimulNumarChitanta  Int       @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  adminId         String
  admin           User     @relation("AdminAsociatie", fields: [adminId], references: [id])

  // Multi-tenant: legătura la organizație
  organizatieId   String?
  organizatie     Organizatie? @relation("OrganizatieAsociatii", fields: [organizatieId], references: [id])

  cladiri         Cladire[]
  scari           Scara[]
  apartamente     Apartament[]
  tipuriApartament TipApartament[]
  cheltuieli      Cheltuiala[]
  chitante        Chitanta[]
  fonduri         Fond[]
  furnizori       Furnizor[]
  tipuriCheltuieliCustom TipCheltuialaCustom[]
  contoare        ContorComun[]
  documente       Document[]
  anunturi        Anunt[]

  // AI
  agentLogs       AgentLog[]
  predictii       PredictieRestanta[]

  // Tichete
  tichete         Tichet[]

  // Conturi bancare si plati
  conturiBancare  ContBancarAsociatie[]
  platiBancare    PlataBancaraPending[]

  // Email & Notifications
  smtpConfig      SMTPConfig?
  reminderHistory ReminderHistory[]

  // Invitations
  invitations     InvitationToken[]

  // SPV / e-Factura
  spvCredentials  SPVCredentials?
  facturiSPV      FacturaSPV[]

  // Audit & Import
  auditLogs       AuditLog[]
  importSessions  ImportSession[]

  @@map("asociatii")
}

model Cladire {
  id          String   @id @default(cuid())
  nume        String?  // Opțional: "Clădirea Principală", "Bloc A", etc.

  asociatieId String
  asociatie   Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  scari       Scara[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("cladiri")
}

model Scara {
  id          String   @id @default(cuid())
  numar       String   // "A", "B", "1", "2"
  etaje       Int      @default(10)

  cladireId   String
  cladire     Cladire @relation(fields: [cladireId], references: [id], onDelete: Cascade)

  // Păstrăm asociatieId pentru queries rapide (denormalizare)
  asociatieId String
  asociatie   Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  apartamente Apartament[]

  @@unique([cladireId, numar])
  @@map("scari")
}

model TipApartament {
  id              String   @id @default(cuid())
  denumire        String   // "2 camere, 49mp"
  nrCamere        Int
  suprafata       Float    // mp
  cotaIndiviza    Float    // procent din bloc

  asociatieId     String
  asociatie       Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  apartamente     Apartament[]

  @@unique([asociatieId, denumire])
  @@map("tipuri_apartamente")
}

model Apartament {
  id              String     @id @default(cuid())
  numar           String     // "1", "2", "15A"
  tipUnitate      TipUnitate @default(APARTAMENT)
  tipUnitateCustom String?   // Denumire custom când tipUnitate = ALTUL
  codUnic         String?    @unique @default(cuid()) // Cod unic auto-generat
  nrCadastral     String?    // Număr cadastral (opțional dar important)
  etaj            Int?
  suprafata       Float?     // mp
  nrCamere        Int?
  cotaIndiviza    Float?     // procent din bloc
  nrPersoane      Int        @default(1)

  // Locuire
  esteInchiriat   Boolean    @default(false)

  // Debranșamente — JSON: { "ascensor": false, "caldura": true, ... }
  debransamente   String?    @db.Text

  asociatieId     String
  asociatie       Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  scaraId         String?
  scara           Scara?   @relation(fields: [scaraId], references: [id])

  tipApartamentId String?
  tipApartament   TipApartament? @relation(fields: [tipApartamentId], references: [id])

  // Relations
  proprietari     ProprietarApartament[]
  chiriasi        Chirias[]
  contoare        Contor[]
  chitante        Chitanta[]
  plati           Plata[]
  indexuri        IndexContor[]
  reminderHistory ReminderHistory[]
  documenteUnitate DocumentUnitate[]

  // Invitations
  invitations     InvitationToken[]

  @@unique([asociatieId, numar])
  @@map("apartamente")
}

model ProprietarApartament {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])

  apartamentId  String
  apartament    Apartament @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  // Ownership details
  cotaParte     Float    @default(100) // procent proprietate
  dataInceput   DateTime @default(now())
  dataSfarsit   DateTime?
  esteActiv     Boolean  @default(true)

  // Contact urgență
  esteContactUrgenta Boolean @default(false)

  createdAt     DateTime @default(now())

  @@unique([userId, apartamentId])
  @@map("proprietari_apartamente")
}

// Chiriaș - pentru apartamente închiriate
model Chirias {
  id            String   @id @default(cuid())
  nume          String
  email         String?
  telefon       String?

  apartamentId  String
  apartament    Apartament @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  // Detalii contract
  dataInceput   DateTime @default(now())
  dataSfarsit   DateTime?
  esteActiv     Boolean  @default(true)

  // Contact urgență
  esteContactUrgenta Boolean @default(false)

  createdAt     DateTime @default(now())

  @@map("chiriasi")
}

// ============================================
// CONTOARE & INDEXURI
// ============================================

enum TipContor {
  APA_RECE
  APA_CALDA
  GAZ
  CURENT
  CALDURA
  IMPULS_BMS          // Sisteme electronice BMS (VRV multi split)
  REPARTITOR_COSTURI  // Repartitoare costuri energie calorică
  CALORIMETRU         // Contor energie termică (distribuție orizontală)
}

// ============================================
// TIP UNITATE (Apartament, Parcare, etc.)
// ============================================

enum TipUnitate {
  APARTAMENT
  PARCARE
  BOXA
  SPATIU_COMERCIAL
  ALTUL              // Parametru customizabil
}

model Contor {
  id            String    @id @default(cuid())
  serie         String?
  tip           TipContor
  unitateMasura String?   // "mc", "kWh", "impuls", "unități repartitor"
  dataInstalare DateTime?
  dataExpirare  DateTime?
  esteActiv     Boolean   @default(true)

  apartamentId  String
  apartament    Apartament @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  indexuri      IndexContor[]

  @@map("contoare")
}

model ContorComun {
  id            String    @id @default(cuid())
  serie         String?
  tip           TipContor
  denumire      String    // "Contor principal apă rece"

  asociatieId   String
  asociatie     Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  indexuri      IndexContorComun[]

  @@map("contoare_comune")
}

model IndexContor {
  id            String   @id @default(cuid())
  valoare       Float
  dataIndex     DateTime
  luna          Int      // 1-12
  an            Int

  // AI OCR
  imagineUrl    String?
  ocrConfidence Float?   // 0-100
  verificatManual Boolean @default(false)

  contorId      String
  contor        Contor   @relation(fields: [contorId], references: [id], onDelete: Cascade)

  apartamentId  String
  apartament    Apartament @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())

  @@unique([contorId, luna, an])
  @@map("indexuri_contoare")
}

model IndexContorComun {
  id          String   @id @default(cuid())
  valoare     Float
  dataIndex   DateTime
  luna        Int
  an          Int

  contorId    String
  contor      ContorComun @relation(fields: [contorId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([contorId, luna, an])
  @@map("indexuri_contoare_comune")
}

// ============================================
// CHELTUIELI & FURNIZORI
// ============================================

model Furnizor {
  id          String   @id @default(cuid())
  nume        String
  cui         String?
  adresa      String?
  telefon     String?
  email       String?
  contBancar  String?

  asociatieId String
  asociatie   Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  cheltuieli  Cheltuiala[]
  plati       PlataFurnizor[]

  @@map("furnizori")
}

enum TipCheltuiala {
  APA_RECE
  APA_CALDA
  CANALIZARE
  GAZ
  CURENT_COMUN
  CALDURA
  ASCENSOR
  CURATENIE
  GUNOI
  FOND_RULMENT
  FOND_REPARATII
  ADMINISTRARE
  ALTE_CHELTUIELI
}

// Tipuri de cheltuieli personalizate (custom)
model TipCheltuialaCustom {
  id              String       @id @default(cuid())
  nume            String       // Ex: "Deratizare", "Dezinsecție", "Întreținere lift"
  descriere       String?
  activ           Boolean      @default(true)

  asociatieId     String
  asociatie       Asociatie    @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  cheltuieli      Cheltuiala[]

  createdAt       DateTime     @default(now())

  @@unique([asociatieId, nume])
  @@map("tipuri_cheltuieli_custom")
}

enum ModRepartizare {
  CONSUM          // pe baza indexurilor
  COTA_INDIVIZA   // pe mp/cota
  PERSOANE        // pe numar persoane
  APARTAMENT      // fix per apartament
  MANUAL          // manual de admin
}

model Cheltuiala {
  id              String         @id @default(cuid())
  tip             TipCheltuiala
  descriere       String?
  suma            Float
  dataFactura     DateTime
  dataScadenta    DateTime?
  nrFactura       String?

  modRepartizare  ModRepartizare @default(COTA_INDIVIZA)
  luna            Int
  an              Int

  // AI OCR extracted
  ocrExtracted    Boolean        @default(false)
  imagineUrl      String?

  asociatieId     String
  asociatie       Asociatie      @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  furnizorId      String?
  furnizor        Furnizor?      @relation(fields: [furnizorId], references: [id])

  // Tip cheltuială personalizat (folosit când tip = ALTE_CHELTUIELI)
  tipCustomId     String?
  tipCustom       TipCheltuialaCustom? @relation(fields: [tipCustomId], references: [id])

  repartizari     Repartizare[]
  platiFurnizor   PlataFurnizor[]

  // Legacy fields (kept for backwards compatibility, use platiFurnizor relation instead)
  platita         Boolean        @default(false)
  dataPlata       DateTime?
  metodaPlataFurnizor MetodaPlata?
  referintaPlata  String?        // Bank reference / receipt number

  createdAt       DateTime       @default(now())

  @@map("cheltuieli")
}

// Plăți către furnizori (pentru tracking plăți parțiale)
model PlataFurnizor {
  id              String      @id @default(cuid())
  suma            Float       // Suma plătită
  dataPlata       DateTime    @default(now())
  metodaPlata     MetodaPlata
  referinta       String?     // Nr. chitanță furnizor / referință bancară / nr. OP

  cheltuialaId    String
  cheltuiala      Cheltuiala  @relation(fields: [cheltuialaId], references: [id], onDelete: Cascade)

  furnizorId      String
  furnizor        Furnizor    @relation(fields: [furnizorId], references: [id])

  createdAt       DateTime    @default(now())

  @@map("plati_furnizori")
}

model Repartizare {
  id            String     @id @default(cuid())
  suma          Float
  detalii       String?    // JSON with calculation details

  cheltuialaId  String
  cheltuiala    Cheltuiala @relation(fields: [cheltuialaId], references: [id], onDelete: Cascade)

  chitantaId    String
  chitanta      Chitanta   @relation(fields: [chitantaId], references: [id], onDelete: Cascade)

  @@map("repartizari")
}

// ============================================
// CHITANTE & PLATI
// ============================================

enum StatusChitanta {
  GENERATA
  TRIMISA
  PARTIAL_PLATITA
  PLATITA
  RESTANTA
}

model Chitanta {
  id              String         @id @default(cuid())
  numar           Int            // auto-increment per asociatie
  luna            Int
  an              Int

  // Sume calculate
  sumaIntretinere Float          // cheltuieli curente
  sumaRestanta    Float          @default(0)
  sumaPenalizare  Float          @default(0)
  sumaFonduri     Float          @default(0)
  sumaTotal       Float

  dataEmitere     DateTime       @default(now())
  dataScadenta    DateTime

  status          StatusChitanta @default(GENERATA)

  // AI generated breakdown
  detaliiJson     String?        @db.Text // JSON cu toate detaliile

  asociatieId     String
  asociatie       Asociatie      @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  apartamentId    String
  apartament      Apartament     @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  repartizari     Repartizare[]
  plati           Plata[]
  reminderHistory ReminderHistory[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([asociatieId, apartamentId, luna, an])
  @@map("chitante")
}

enum MetodaPlata {
  CASH
  CARD
  TRANSFER
  ALTELE
}

enum StatusPlata {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

model Plata {
  id              String      @id @default(cuid())
  suma            Float
  dataPlata       DateTime    @default(now())
  metodaPlata     MetodaPlata
  status          StatusPlata @default(CONFIRMED)

  // Receipt issued by association (chitanța de încasare)
  serieChitantaIncasare  String?
  numarChitantaIncasare  Int?

  // Payment gateway
  stripePaymentId String?
  referinta       String?     // Bank reference

  chitantaId      String
  chitanta        Chitanta    @relation(fields: [chitantaId], references: [id], onDelete: Cascade)

  apartamentId    String
  apartament      Apartament  @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  userId          String?
  user            User?       @relation(fields: [userId], references: [id])

  createdAt       DateTime    @default(now())

  @@map("plati")
}

// ============================================
// FONDURI
// ============================================

enum TipFond {
  RULMENT
  REPARATII
  ALTE
}

model Fond {
  id          String   @id @default(cuid())
  tip         TipFond
  denumire    String
  sumaLunara  Float    // suma pe apartament/luna
  soldCurent  Float    @default(0)

  asociatieId String
  asociatie   Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  @@map("fonduri")
}

// ============================================
// DOCUMENTE & ANUNTURI
// ============================================

enum TipDocument {
  AVG
  BUGET
  REGULAMENT
  CONTRACT
  FACTURA
  ALTELE
}

model Document {
  id          String      @id @default(cuid())
  tip         TipDocument
  titlu       String
  descriere   String?
  fisierUrl   String
  fisierNume  String

  asociatieId String
  asociatie   Asociatie   @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt   DateTime    @default(now())

  @@map("documente")
}

model Anunt {
  id          String   @id @default(cuid())
  titlu       String
  continut    String   @db.Text
  important   Boolean  @default(false)

  asociatieId String
  asociatie   Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  expiresAt   DateTime?

  @@map("anunturi")
}

// ============================================
// NOTIFICARI
// ============================================

enum TipNotificare {
  CHITANTA_NOUA
  PLATA_CONFIRMATA
  REMINDER_PLATA
  ANUNT_NOU
  INDEX_REMINDER
  SISTEM
}

model Notificare {
  id          String         @id @default(cuid())
  tip         TipNotificare
  titlu       String
  mesaj       String
  citita      Boolean        @default(false)

  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime       @default(now())

  @@map("notificari")
}

// ============================================
// TICHETE / SESIZARI
// ============================================

enum StatusTichet {
  DESCHIS
  IN_LUCRU
  REZOLVAT
  INCHIS
}

enum CategorieTichet {
  DEFECTIUNE       // Probleme tehnice (lift, instalații)
  CURATENIE        // Probleme curățenie
  ZGOMOT           // Reclamații zgomot
  PARCARE          // Probleme parcare
  ILUMINAT         // Iluminat comun
  SUGGESTIE        // Sugestii îmbunătățiri
  FINANCIAR        // Întrebări financiare
  ALTELE
}

enum PrioritateTichet {
  SCAZUTA
  NORMALA
  URGENTA
}

model Tichet {
  id            String           @id @default(cuid())
  numar         Int              // Auto-increment per asociatie
  titlu         String
  descriere     String           @db.Text
  categorie     CategorieTichet
  prioritate    PrioritateTichet @default(NORMALA)
  status        StatusTichet     @default(DESCHIS)

  // Imagini atașate
  imagini       String[]         // URLs

  // Localizare opțională
  locatie       String?          // "Scara A, etaj 3" sau "Parcare subterană"

  // Timestamps
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  rezolvatLa    DateTime?

  // Relations
  asociatieId   String
  asociatie     Asociatie        @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  creatorId     String
  creator       User             @relation("TicheteCreate", fields: [creatorId], references: [id])

  asignatId     String?
  asignat       User?            @relation("TicheteAsignate", fields: [asignatId], references: [id])

  comentarii    ComentariuTichet[]

  @@map("tichete")
}

model ComentariuTichet {
  id          String   @id @default(cuid())
  continut    String   @db.Text
  esteIntern  Boolean  @default(false)  // Comentariu doar pentru admin

  tichetId    String
  tichet      Tichet   @relation(fields: [tichetId], references: [id], onDelete: Cascade)

  autorId     String
  autor       User     @relation(fields: [autorId], references: [id])

  createdAt   DateTime @default(now())

  @@map("comentarii_tichete")
}

// ============================================
// CONTURI BANCARE & PLATI BANCARE
// ============================================

model ContBancarAsociatie {
  id           String   @id @default(cuid())
  nume         String   // "Cont BT Principal", "Cont ING Cheltuieli"
  iban         String
  banca        String   // "Banca Transilvania", "ING Bank"
  codBic       String?  // BIC/SWIFT code
  esteImplicit Boolean  @default(false)

  asociatieId  String
  asociatie    Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  platiPending PlataBancaraPending[]

  createdAt    DateTime @default(now())

  @@map("conturi_bancare_asociatie")
}

enum StatusPlataBancara {
  PENDING     // In asteptare export
  EXPORTED    // Exportat in fisier
  PAID        // Confirmat platit
}

model PlataBancaraPending {
  id                String   @id @default(cuid())

  // Beneficiary (furnizor)
  beneficiarNume    String
  beneficiarIban    String
  beneficiarBanca   String?
  beneficiarCui     String?

  suma              Float
  descriere         String   // Payment description
  referinta         String?  // Reference for the payment

  // Source bank account
  contBancarId      String
  contBancar        ContBancarAsociatie @relation(fields: [contBancarId], references: [id])

  // Link to expense
  cheltuialaId      String?

  // Status
  status            StatusPlataBancara @default(PENDING)
  exportedAt        DateTime?
  paidAt            DateTime?

  asociatieId       String
  asociatie         Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())

  @@map("plati_bancare_pending")
}

// ============================================
// AI AGENTS
// ============================================

enum AgentType {
  OCR_FACTURA       // Extrage date din facturi
  OCR_INDEX         // Citeste indexuri contoare
  CALCUL_CHITANTA   // Genereaza chitante
  PREDICTIE_PLATA   // Prezice restante
  CHATBOT           // Raspunde la intrebari
  RECONCILIERE      // Match plati cu chitante
  REMINDER          // Trimite remindere
  RAPORT            // Genereaza rapoarte
}

model AgentLog {
  id          String    @id @default(cuid())
  agentType   AgentType
  input       String    @db.Text
  output      String    @db.Text
  success     Boolean
  errorMsg    String?
  durationMs  Int
  tokensUsed  Int?
  cost        Float?    // in USD

  asociatieId String?
  asociatie   Asociatie? @relation(fields: [asociatieId], references: [id])

  userId      String?
  user        User?      @relation(fields: [userId], references: [id])

  createdAt   DateTime  @default(now())

  @@map("agent_logs")
}

model PredictieRestanta {
  id              String   @id @default(cuid())
  apartamentId    String
  luna            Int
  an              Int

  probabilitate   Float    // 0-100
  sumaEstimata    Float
  factori         String   @db.Text // JSON

  asociatieId     String
  asociatie       Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([asociatieId, apartamentId, luna, an])
  @@map("predictii_restante")
}

// ============================================
// SMTP CONFIGURATION
// ============================================

model SMTPConfig {
  id              String   @id @default(cuid())

  host            String   // smtp.gmail.com, smtp.office365.com, etc.
  port            Int      @default(587)
  secure          Boolean  @default(false) // true for port 465 (SSL)
  user            String   // SMTP username/email
  password        String   // SMTP password (encrypted in production)

  fromEmail       String   // Email address to send from
  fromName        String?  // Display name for sender

  enabled         Boolean  @default(false)
  lastTest        DateTime?
  lastTestSuccess Boolean?
  lastTestError   String?

  asociatieId     String   @unique
  asociatie       Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("smtp_configs")
}

// ============================================
// REMINDER HISTORY (for tracking sent reminders)
// ============================================

enum ReminderType {
  BEFORE_DUE      // Reminder before due date
  ON_DUE          // Reminder on due date
  AFTER_DUE       // Reminder after due date (overdue)
  ESCALATION      // Escalated reminder
  WEEKLY_SUMMARY  // Weekly summary for admin
}

enum ReminderChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

model ReminderHistory {
  id              String          @id @default(cuid())

  tip             ReminderType
  canal           ReminderChannel
  mesaj           String          @db.Text

  trimisLa        DateTime        @default(now())
  deschisLa       DateTime?       // For email open tracking

  apartamentId    String
  apartament      Apartament      @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  chitantaId      String?
  chitanta        Chitanta?       @relation(fields: [chitantaId], references: [id], onDelete: SetNull)

  asociatieId     String
  asociatie       Asociatie       @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt       DateTime        @default(now())

  @@map("reminder_history")
}

// ============================================
// SPV / e-FACTURA INTEGRATION (ANAF)
// ============================================

model SPVCredentials {
  id              String    @id @default(cuid())

  cuiAsociatie    String    // CUI-ul asociației pentru care sunt credentialele
  accessToken     String?   @db.Text
  refreshToken    String?   @db.Text
  expiresAt       DateTime?

  // OAuth state for verification
  oauthState      String?

  // Sync status
  lastSync        DateTime?
  lastSyncError   String?

  asociatieId     String    @unique
  asociatie       Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("spv_credentials")
}

enum FacturaSPVStatus {
  NOUA          // Newly downloaded, not processed
  PROCESATA     // Processed and linked to Cheltuiala
  IGNORATA      // Manually marked as ignored
  EROARE        // Error during processing
}

model FacturaSPV {
  id              String           @id @default(cuid())

  // ANAF identifiers
  spvId           String           // ID from ANAF system (id_solicitare)
  idDescarcare    String?          // Download ID

  // Supplier info
  cuiFurnizor     String
  numeFurnizor    String

  // Invoice details
  numarFactura    String
  dataFactura     DateTime
  dataScadenta    DateTime?

  // Amounts
  sumaTotal       Float
  sumaTVA         Float?
  moneda          String           @default("RON")

  // Files
  xmlUrl          String?          @db.Text  // URL or base64 XML content
  pdfUrl          String?          @db.Text  // URL or path to PDF

  // Processing status
  status          FacturaSPVStatus @default(NOUA)

  // Link to Cheltuiala when processed
  cheltuialaId    String?
  // Note: We don't create a relation here to keep it flexible

  // Metadata
  detaliiJson     String?          @db.Text  // Full JSON from ANAF

  asociatieId     String
  asociatie       Asociatie        @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  importedAt      DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([asociatieId, spvId])
  @@index([asociatieId, status])
  @@index([cuiFurnizor])
  @@map("facturi_spv")
}

// ============================================
// MULTI-TENANT & ORGANIZAȚII
// ============================================

model Organizatie {
  id              String   @id @default(cuid())
  nume            String   // "SC Admin Bloc SRL"
  cui             String?  @unique
  adresa          String?
  email           String?
  telefon         String?
  logo            String?  // URL logo pentru white-label (placeholder)

  // Billing
  emailFacturare  String?

  // Status
  status          OrgStatus @default(ACTIVA)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  abonament       Abonament?
  utilizatori     UtilizatorOrganizatie[]
  asociatii       Asociatie[]              @relation("OrganizatieAsociatii")

  // Usage tracking
  usageLogs       UsageLog[]

  // White-label
  whiteLabel      WhiteLabelConfig?

  @@map("organizatii")
}

enum OrgStatus {
  ACTIVA
  SUSPENDATA    // Plată întârziată
  INCHISA       // Cont închis
  TRIAL         // Perioadă de probă
}

// ============================================
// UTILIZATORI ÎN ORGANIZAȚIE (Roluri per Org)
// ============================================

model UtilizatorOrganizatie {
  id              String   @id @default(cuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizatieId   String
  organizatie     Organizatie @relation(fields: [organizatieId], references: [id], onDelete: Cascade)

  rol             RolOrganizatie @default(MEMBRU)

  // Permisiuni specifice (override default din rol)
  permisiuniCustom String?  @db.Text // JSON array of permission codes

  // Access la asociații specifice (empty = toate)
  asociatiiAccess  String[] // array of asociatie IDs, empty = all

  // Status
  esteActiv       Boolean  @default(true)
  invitedAt       DateTime @default(now())
  acceptedAt      DateTime?

  createdAt       DateTime @default(now())

  @@unique([userId, organizatieId])
  @@map("utilizatori_organizatie")
}

enum RolOrganizatie {
  OWNER           // Proprietarul organizației (full access)
  ADMIN           // Administrator (manage users, settings)
  MANAGER         // Manager asociații (CRUD pe date)
  CONTABIL        // Acces doar financiar (read/write financiar)
  OPERATOR        // Operator (înregistrare plăți, indexuri)
  VIZUALIZARE     // Doar citire (rapoarte)
  MEMBRU          // Rol implicit
}

// ============================================
// PLANURI & ABONAMENTE (Freemium)
// ============================================

model Plan {
  id              String   @id @default(cuid())
  cod             String   @unique // FREE, STARTER, PRO, ENTERPRISE
  nume            String   // "Plan Gratuit", "Starter", etc.
  descriere       String?

  // Prețuri
  pretPerApartament Float   // lei/apt/lună
  pretMinimLunar    Float   @default(0) // preț minim garantat

  // Module incluse
  moduleIncluse     ModulFunctional[]

  // Limite (JSON)
  limiteJson        String  @db.Text // JSON cu toate limitele

  // Status
  esteActiv         Boolean @default(true)
  estePublic        Boolean @default(true) // vizibil pe pricing page

  // Ordine afișare
  ordine            Int     @default(0)

  abonamente        Abonament[]

  createdAt         DateTime @default(now())

  @@map("planuri")
}

model ModulFunctional {
  id              String   @id @default(cuid())
  cod             String   @unique // BAZA, FINANCIAR, AUTOMATIZARI, INTEGRARI
  nume            String
  descriere       String?

  // Features din acest modul (pentru UI și verificări)
  featuresJson    String   @db.Text // JSON array of feature codes

  // Care planuri îl includ
  planuri         Plan[]

  @@map("module_functionale")
}

model Abonament {
  id              String   @id @default(cuid())

  organizatieId   String   @unique
  organizatie     Organizatie @relation(fields: [organizatieId], references: [id], onDelete: Cascade)

  planId          String
  plan            Plan     @relation(fields: [planId], references: [id])

  // Status abonament
  status          StatusAbonament @default(TRIAL)

  // Perioadă
  dataStart       DateTime @default(now())
  dataExpirare    DateTime?
  perioadaTrial   DateTime? // când expiră trial-ul

  // Billing
  ciclulFacturare CiclulFacturare @default(LUNAR)
  dataUrmatoareiFacturi DateTime?

  // Stripe
  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Override limite (pentru deals custom)
  limiteCustomJson     String?  @db.Text

  // Module extra achiziționate separat
  moduleExtra          String[] // coduri module

  // Read-only mode pentru downgrade
  readOnlyModules      String[] // coduri module în read-only

  // Snapshot la momentul downgrade-ului
  downgradeSnapshot    String?  @db.Text // JSON cu starea la downgrade
  downgradedAt         DateTime?
  previousPlanId       String?

  // Istoric facturi
  facturiAbonament     FacturaAbonament[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("abonamente")
}

enum StatusAbonament {
  TRIAL           // Perioadă de probă
  ACTIV           // Plătit și activ
  EXPIRAT         // Trecut de data expirării
  SUSPENDAT       // Suspendat pentru neplată
  ANULAT          // Anulat de client
}

enum CiclulFacturare {
  LUNAR
  TRIMESTRIAL
  ANUAL
}

model FacturaAbonament {
  id              String   @id @default(cuid())

  abonamentId     String
  abonament       Abonament @relation(fields: [abonamentId], references: [id])

  numar           String   // FA-2024-0001
  dataEmitere     DateTime @default(now())
  dataScadenta    DateTime

  // Detalii
  perioada        String   // "Ianuarie 2024"
  nrApartamente   Int      // câte apt au fost facturate
  pretUnitar      Float    // preț/apt în acel moment

  // Sume
  subtotal        Float
  tva             Float
  total           Float

  // Status
  status          StatusFacturaAbonament @default(EMISA)
  dataPlatii      DateTime?

  // Stripe
  stripeInvoiceId String?

  createdAt       DateTime @default(now())

  @@map("facturi_abonament")
}

enum StatusFacturaAbonament {
  DRAFT
  EMISA
  PLATITA
  ANULATA
}

// ============================================
// USAGE TRACKING (pentru limite)
// ============================================

model UsageLog {
  id              String   @id @default(cuid())

  organizatieId   String
  organizatie     Organizatie @relation(fields: [organizatieId], references: [id])

  // Ce s-a folosit
  tipResursa      TipResursa
  cantitate       Int      @default(1)

  // Context
  asociatieId     String?
  userId          String?
  detalii         String?  // JSON cu context extra

  createdAt       DateTime @default(now())

  @@index([organizatieId, tipResursa, createdAt])
  @@map("usage_logs")
}

enum TipResursa {
  AI_REQUEST      // Cerere AI (OCR, predicții)
  EMAIL_SENT      // Email trimis
  DOCUMENT_UPLOAD // Document uploadat
  API_CALL        // Apel API extern
}

// ============================================
// PLATFORM SETTINGS (Super Admin Only)
// ============================================

model PlatformSettings {
  id              String   @id @default("default") // Singleton

  // Trial & Grace Period (configurabile din Super Admin)
  trialDays       Int      @default(14)    // Zile trial cu toate modulele
  graceDays       Int      @default(7)     // Zile după expirare înainte de suspendare

  // Notifications timing
  trialWarningDays    Int[]  @default([7, 3, 1])   // Când să trimită avertismente trial
  paymentWarningDays  Int[]  @default([7, 3, 1])   // Când să trimită avertismente plată

  // Feature toggles (kill switches)
  aiEnabled           Boolean @default(true)
  spvEnabled          Boolean @default(true)
  stripeEnabled       Boolean @default(true)

  // Platform branding (default, poate fi overriden per organizație)
  platformName        String  @default("BlocHub")
  platformLogo        String? // URL logo default
  platformFavicon     String?
  primaryColor        String  @default("#2563eb") // blue-600
  supportEmail        String  @default("support@blochub.ro")

  // Legal
  termsUrl            String?
  privacyUrl          String?

  // Maintenance mode
  maintenanceMode     Boolean @default(false)
  maintenanceMessage  String?

  // ============================================
  // REVOLUT PAYMENT GATEWAY
  // ============================================
  revolutEnabled      Boolean @default(false)
  revolutEnvironment  String  @default("sandbox") // sandbox or production
  revolutApiKey       String? // sk_xxx... (encrypted in production)
  revolutWebhookSecret String? // whsec_xxx...

  // ============================================
  // COMPANY BILLING DETAILS (for invoices)
  // ============================================
  companyName         String  @default("BlocHub SRL")
  companyCui          String? // CUI/CIF
  companyRegCom       String? // Nr. Reg. Com.
  companyAddress      String?
  companyCity         String?
  companyCounty       String?
  companyCountry      String  @default("România")
  companyIban         String? // Cont bancar
  companyBank         String? // Numele băncii
  companyEmail        String? // Email facturare
  companyPhone        String?

  // TVA settings
  companyIsVatPayer   Boolean @default(true)
  vatRate             Float   @default(0.19) // 19% TVA

  updatedAt       DateTime @updatedAt
  updatedBy       String?  // userId who last updated

  @@map("platform_settings")
}

// ============================================
// WHITE-LABEL CONFIG (Enterprise)
// ============================================

model WhiteLabelConfig {
  id              String   @id @default(cuid())

  organizatieId   String   @unique
  organizatie     Organizatie @relation(fields: [organizatieId], references: [id], onDelete: Cascade)

  // Branding
  logo            String?  // URL to uploaded logo
  logoLight       String?  // Logo pentru dark mode
  favicon         String?
  appName         String?  // ex: "AdminBloc Pro"

  // Culori (CSS hex)
  primaryColor    String?  // #2563eb
  accentColor     String?  // #10b981

  // Email branding
  emailHeaderHtml String?  @db.Text
  emailFooterHtml String?  @db.Text
  emailFromName   String?  // "Administrare Bloc X"

  // Custom domain (future)
  customDomain    String?  @unique
  domainVerified  Boolean  @default(false)
  sslCertId       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("white_label_configs")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id              String   @id @default(cuid())
  userId          String?
  userName        String?  // Denormalizat pentru istoric

  actiune         String   // "CREATE_APARTAMENT", "RESET_CONTOR", etc.
  entitate        String   // "Apartament", "IndexContor", etc.
  entitatId       String?

  valoriVechi     String?  @db.Text // JSON snapshot înainte
  valoriNoi       String?  @db.Text // JSON snapshot după

  notaExplicativa String?  @db.Text // Obligatoriu pentru anumite operații

  asociatieId     String?
  asociatie       Asociatie? @relation(fields: [asociatieId], references: [id])

  ipAddress       String?

  createdAt       DateTime @default(now())

  @@index([asociatieId, createdAt])
  @@index([entitate, entitatId])
  @@map("audit_logs")
}

// ============================================
// IMPORT SYSTEM
// ============================================

enum ImportStatus {
  PENDING       // Fișier încărcat
  MAPPING       // Mapare coloane
  VALIDATING    // Validare în curs
  READY         // Validat, gata de confirmare
  PROCESSING    // Se creează înregistrările
  COMPLETED     // Finalizat
  FAILED        // Eroare
}

model ImportSession {
  id              String       @id @default(cuid())

  asociatieId     String
  asociatie       Asociatie    @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  userId          String
  user            User         @relation(fields: [userId], references: [id])

  // Fișier
  tipFisier       String       // "EXCEL", "PDF"
  numeFisier      String
  fisierUrl       String?      // URL storage (opțional, datele pot fi în parsedDataJson)

  status          ImportStatus @default(PENDING)
  stepCurent      Int          @default(1) // 1-4

  // Step 2: Mapare
  selectedSheet   String?
  colonneMapping  String?      @db.Text // JSON: { "Numar casa": "numar", ... }

  // Step 3: Validare
  errorsJson      String?      @db.Text // JSON: erori blocante
  warningsJson    String?      @db.Text // JSON: avertismente

  // Date parsate (cache, evită re-parsare)
  parsedDataJson  String?      @db.Text // JSON: toate rândurile parsate

  // Step 4: Rezultat
  createdCount    Int          @default(0)
  updatedCount    Int          @default(0)
  skippedCount    Int          @default(0)

  createdAt       DateTime     @default(now())
  completedAt     DateTime?

  @@index([asociatieId, status])
  @@map("import_sessions")
}

// ============================================
// DOCUMENTE PER UNITATE (DMS)
// ============================================

enum TipDocumentUnitate {
  CONTRACT_PROPRIETATE
  BULETIN_ID
  CONTRACT_INCHIRIERE
  CERTIFICAT_FISCAL
  ALTELE
}

model DocumentUnitate {
  id            String             @id @default(cuid())
  tip           TipDocumentUnitate
  titlu         String
  descriere     String?
  fisierUrl     String
  fisierNume    String
  fisierSize    Int?               // bytes

  apartamentId  String
  apartament    Apartament         @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  uploadedById  String

  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([apartamentId])
  @@map("documente_unitati")
}
