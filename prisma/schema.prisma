generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTH & USERS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  phone         String?
  password      String?
  image         String?
  role          UserRole  @default(PROPRIETAR)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]

  // Admin relations
  asociatiiAdmin Asociatie[] @relation("AdminAsociatie")

  // Proprietar relations
  apartamente   ProprietarApartament[]
  plati         Plata[]
  notificari    Notificare[]

  // AI Agent activity
  agentLogs     AgentLog[]

  // Tichete
  ticheteCreate    Tichet[]           @relation("TicheteCreate")
  ticheteAsignate  Tichet[]           @relation("TicheteAsignate")
  comentariiTichet ComentariuTichet[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@map("password_reset_tokens")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PROPRIETAR
}

// ============================================
// ASOCIATIE & BLOC
// ============================================

model Asociatie {
  id              String   @id @default(cuid())
  nume            String
  cui             String?  @unique
  adresa          String
  oras            String
  judet           String
  codPostal       String?

  // Contact
  email           String?
  telefon         String?

  // Financiar
  contBancar      String?
  banca           String?

  // Settings
  ziScadenta      Int      @default(25)
  penalizareZi    Float    @default(0.02) // 0.02% pe zi

  // Chitanțier (Receipt Book)
  serieChitantier       String?   // ex: "CHT", "ABC"
  numarChitantierStart  Int       @default(1)
  ultimulNumarChitanta  Int       @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  adminId         String
  admin           User     @relation("AdminAsociatie", fields: [adminId], references: [id])

  cladiri         Cladire[]
  scari           Scara[]
  apartamente     Apartament[]
  tipuriApartament TipApartament[]
  cheltuieli      Cheltuiala[]
  chitante        Chitanta[]
  fonduri         Fond[]
  furnizori       Furnizor[]
  tipuriCheltuieliCustom TipCheltuialaCustom[]
  contoare        ContorComun[]
  documente       Document[]
  anunturi        Anunt[]

  // AI
  agentLogs       AgentLog[]
  predictii       PredictieRestanta[]

  // Tichete
  tichete         Tichet[]

  // Conturi bancare si plati
  conturiBancare  ContBancarAsociatie[]
  platiBancare    PlataBancaraPending[]

  @@map("asociatii")
}

model Cladire {
  id          String   @id @default(cuid())
  nume        String?  // Opțional: "Clădirea Principală", "Bloc A", etc.

  asociatieId String
  asociatie   Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  scari       Scara[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("cladiri")
}

model Scara {
  id          String   @id @default(cuid())
  numar       String   // "A", "B", "1", "2"
  etaje       Int      @default(10)

  cladireId   String
  cladire     Cladire @relation(fields: [cladireId], references: [id], onDelete: Cascade)

  // Păstrăm asociatieId pentru queries rapide (denormalizare)
  asociatieId String
  asociatie   Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  apartamente Apartament[]

  @@unique([cladireId, numar])
  @@map("scari")
}

model TipApartament {
  id              String   @id @default(cuid())
  denumire        String   // "2 camere, 49mp"
  nrCamere        Int
  suprafata       Float    // mp
  cotaIndiviza    Float    // procent din bloc

  asociatieId     String
  asociatie       Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  apartamente     Apartament[]

  @@unique([asociatieId, denumire])
  @@map("tipuri_apartamente")
}

model Apartament {
  id              String   @id @default(cuid())
  numar           String   // "1", "2", "15A"
  etaj            Int?
  suprafata       Float?   // mp
  nrCamere        Int?
  cotaIndiviza    Float?   // procent din bloc
  nrPersoane      Int      @default(1)

  // Locuire
  esteInchiriat   Boolean  @default(false)

  asociatieId     String
  asociatie       Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  scaraId         String?
  scara           Scara?   @relation(fields: [scaraId], references: [id])

  tipApartamentId String?
  tipApartament   TipApartament? @relation(fields: [tipApartamentId], references: [id])

  // Relations
  proprietari     ProprietarApartament[]
  chiriasi        Chirias[]
  contoare        Contor[]
  chitante        Chitanta[]
  plati           Plata[]
  indexuri        IndexContor[]

  @@unique([asociatieId, numar])
  @@map("apartamente")
}

model ProprietarApartament {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])

  apartamentId  String
  apartament    Apartament @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  // Ownership details
  cotaParte     Float    @default(100) // procent proprietate
  dataInceput   DateTime @default(now())
  dataSfarsit   DateTime?
  esteActiv     Boolean  @default(true)

  // Contact urgență
  esteContactUrgenta Boolean @default(false)

  createdAt     DateTime @default(now())

  @@unique([userId, apartamentId])
  @@map("proprietari_apartamente")
}

// Chiriaș - pentru apartamente închiriate
model Chirias {
  id            String   @id @default(cuid())
  nume          String
  email         String?
  telefon       String?

  apartamentId  String
  apartament    Apartament @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  // Detalii contract
  dataInceput   DateTime @default(now())
  dataSfarsit   DateTime?
  esteActiv     Boolean  @default(true)

  // Contact urgență
  esteContactUrgenta Boolean @default(false)

  createdAt     DateTime @default(now())

  @@map("chiriasi")
}

// ============================================
// CONTOARE & INDEXURI
// ============================================

enum TipContor {
  APA_RECE
  APA_CALDA
  GAZ
  CURENT
  CALDURA
}

model Contor {
  id            String    @id @default(cuid())
  serie         String?
  tip           TipContor
  dataInstalare DateTime?
  dataExpirare  DateTime?
  esteActiv     Boolean   @default(true)

  apartamentId  String
  apartament    Apartament @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  indexuri      IndexContor[]

  @@map("contoare")
}

model ContorComun {
  id            String    @id @default(cuid())
  serie         String?
  tip           TipContor
  denumire      String    // "Contor principal apă rece"

  asociatieId   String
  asociatie     Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  indexuri      IndexContorComun[]

  @@map("contoare_comune")
}

model IndexContor {
  id            String   @id @default(cuid())
  valoare       Float
  dataIndex     DateTime
  luna          Int      // 1-12
  an            Int

  // AI OCR
  imagineUrl    String?
  ocrConfidence Float?   // 0-100
  verificatManual Boolean @default(false)

  contorId      String
  contor        Contor   @relation(fields: [contorId], references: [id], onDelete: Cascade)

  apartamentId  String
  apartament    Apartament @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())

  @@unique([contorId, luna, an])
  @@map("indexuri_contoare")
}

model IndexContorComun {
  id          String   @id @default(cuid())
  valoare     Float
  dataIndex   DateTime
  luna        Int
  an          Int

  contorId    String
  contor      ContorComun @relation(fields: [contorId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([contorId, luna, an])
  @@map("indexuri_contoare_comune")
}

// ============================================
// CHELTUIELI & FURNIZORI
// ============================================

model Furnizor {
  id          String   @id @default(cuid())
  nume        String
  cui         String?
  adresa      String?
  telefon     String?
  email       String?
  contBancar  String?

  asociatieId String
  asociatie   Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  cheltuieli  Cheltuiala[]
  plati       PlataFurnizor[]

  @@map("furnizori")
}

enum TipCheltuiala {
  APA_RECE
  APA_CALDA
  CANALIZARE
  GAZ
  CURENT_COMUN
  CALDURA
  ASCENSOR
  CURATENIE
  GUNOI
  FOND_RULMENT
  FOND_REPARATII
  ADMINISTRARE
  ALTE_CHELTUIELI
}

// Tipuri de cheltuieli personalizate (custom)
model TipCheltuialaCustom {
  id              String       @id @default(cuid())
  nume            String       // Ex: "Deratizare", "Dezinsecție", "Întreținere lift"
  descriere       String?
  activ           Boolean      @default(true)

  asociatieId     String
  asociatie       Asociatie    @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  cheltuieli      Cheltuiala[]

  createdAt       DateTime     @default(now())

  @@unique([asociatieId, nume])
  @@map("tipuri_cheltuieli_custom")
}

enum ModRepartizare {
  CONSUM          // pe baza indexurilor
  COTA_INDIVIZA   // pe mp/cota
  PERSOANE        // pe numar persoane
  APARTAMENT      // fix per apartament
  MANUAL          // manual de admin
}

model Cheltuiala {
  id              String         @id @default(cuid())
  tip             TipCheltuiala
  descriere       String?
  suma            Float
  dataFactura     DateTime
  dataScadenta    DateTime?
  nrFactura       String?

  modRepartizare  ModRepartizare @default(COTA_INDIVIZA)
  luna            Int
  an              Int

  // AI OCR extracted
  ocrExtracted    Boolean        @default(false)
  imagineUrl      String?

  asociatieId     String
  asociatie       Asociatie      @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  furnizorId      String?
  furnizor        Furnizor?      @relation(fields: [furnizorId], references: [id])

  // Tip cheltuială personalizat (folosit când tip = ALTE_CHELTUIELI)
  tipCustomId     String?
  tipCustom       TipCheltuialaCustom? @relation(fields: [tipCustomId], references: [id])

  repartizari     Repartizare[]
  platiFurnizor   PlataFurnizor[]

  // Legacy fields (kept for backwards compatibility, use platiFurnizor relation instead)
  platita         Boolean        @default(false)
  dataPlata       DateTime?
  metodaPlataFurnizor MetodaPlata?
  referintaPlata  String?        // Bank reference / receipt number

  createdAt       DateTime       @default(now())

  @@map("cheltuieli")
}

// Plăți către furnizori (pentru tracking plăți parțiale)
model PlataFurnizor {
  id              String      @id @default(cuid())
  suma            Float       // Suma plătită
  dataPlata       DateTime    @default(now())
  metodaPlata     MetodaPlata
  referinta       String?     // Nr. chitanță furnizor / referință bancară / nr. OP

  cheltuialaId    String
  cheltuiala      Cheltuiala  @relation(fields: [cheltuialaId], references: [id], onDelete: Cascade)

  furnizorId      String
  furnizor        Furnizor    @relation(fields: [furnizorId], references: [id])

  createdAt       DateTime    @default(now())

  @@map("plati_furnizori")
}

model Repartizare {
  id            String     @id @default(cuid())
  suma          Float
  detalii       String?    // JSON with calculation details

  cheltuialaId  String
  cheltuiala    Cheltuiala @relation(fields: [cheltuialaId], references: [id], onDelete: Cascade)

  chitantaId    String
  chitanta      Chitanta   @relation(fields: [chitantaId], references: [id], onDelete: Cascade)

  @@map("repartizari")
}

// ============================================
// CHITANTE & PLATI
// ============================================

enum StatusChitanta {
  GENERATA
  TRIMISA
  PARTIAL_PLATITA
  PLATITA
  RESTANTA
}

model Chitanta {
  id              String         @id @default(cuid())
  numar           Int            // auto-increment per asociatie
  luna            Int
  an              Int

  // Sume calculate
  sumaIntretinere Float          // cheltuieli curente
  sumaRestanta    Float          @default(0)
  sumaPenalizare  Float          @default(0)
  sumaFonduri     Float          @default(0)
  sumaTotal       Float

  dataEmitere     DateTime       @default(now())
  dataScadenta    DateTime

  status          StatusChitanta @default(GENERATA)

  // AI generated breakdown
  detaliiJson     String?        @db.Text // JSON cu toate detaliile

  asociatieId     String
  asociatie       Asociatie      @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  apartamentId    String
  apartament      Apartament     @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  repartizari     Repartizare[]
  plati           Plata[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([asociatieId, apartamentId, luna, an])
  @@map("chitante")
}

enum MetodaPlata {
  CASH
  CARD
  TRANSFER
  ALTELE
}

enum StatusPlata {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

model Plata {
  id              String      @id @default(cuid())
  suma            Float
  dataPlata       DateTime    @default(now())
  metodaPlata     MetodaPlata
  status          StatusPlata @default(CONFIRMED)

  // Receipt issued by association (chitanța de încasare)
  serieChitantaIncasare  String?
  numarChitantaIncasare  Int?

  // Payment gateway
  stripePaymentId String?
  referinta       String?     // Bank reference

  chitantaId      String
  chitanta        Chitanta    @relation(fields: [chitantaId], references: [id], onDelete: Cascade)

  apartamentId    String
  apartament      Apartament  @relation(fields: [apartamentId], references: [id], onDelete: Cascade)

  userId          String?
  user            User?       @relation(fields: [userId], references: [id])

  createdAt       DateTime    @default(now())

  @@map("plati")
}

// ============================================
// FONDURI
// ============================================

enum TipFond {
  RULMENT
  REPARATII
  ALTE
}

model Fond {
  id          String   @id @default(cuid())
  tip         TipFond
  denumire    String
  sumaLunara  Float    // suma pe apartament/luna
  soldCurent  Float    @default(0)

  asociatieId String
  asociatie   Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  @@map("fonduri")
}

// ============================================
// DOCUMENTE & ANUNTURI
// ============================================

enum TipDocument {
  AVG
  BUGET
  REGULAMENT
  CONTRACT
  FACTURA
  ALTELE
}

model Document {
  id          String      @id @default(cuid())
  tip         TipDocument
  titlu       String
  descriere   String?
  fisierUrl   String
  fisierNume  String

  asociatieId String
  asociatie   Asociatie   @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt   DateTime    @default(now())

  @@map("documente")
}

model Anunt {
  id          String   @id @default(cuid())
  titlu       String
  continut    String   @db.Text
  important   Boolean  @default(false)

  asociatieId String
  asociatie   Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  expiresAt   DateTime?

  @@map("anunturi")
}

// ============================================
// NOTIFICARI
// ============================================

enum TipNotificare {
  CHITANTA_NOUA
  PLATA_CONFIRMATA
  REMINDER_PLATA
  ANUNT_NOU
  INDEX_REMINDER
  SISTEM
}

model Notificare {
  id          String         @id @default(cuid())
  tip         TipNotificare
  titlu       String
  mesaj       String
  citita      Boolean        @default(false)

  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime       @default(now())

  @@map("notificari")
}

// ============================================
// TICHETE / SESIZARI
// ============================================

enum StatusTichet {
  DESCHIS
  IN_LUCRU
  REZOLVAT
  INCHIS
}

enum CategorieTichet {
  DEFECTIUNE       // Probleme tehnice (lift, instalații)
  CURATENIE        // Probleme curățenie
  ZGOMOT           // Reclamații zgomot
  PARCARE          // Probleme parcare
  ILUMINAT         // Iluminat comun
  SUGGESTIE        // Sugestii îmbunătățiri
  FINANCIAR        // Întrebări financiare
  ALTELE
}

enum PrioritateTichet {
  SCAZUTA
  NORMALA
  URGENTA
}

model Tichet {
  id            String           @id @default(cuid())
  numar         Int              // Auto-increment per asociatie
  titlu         String
  descriere     String           @db.Text
  categorie     CategorieTichet
  prioritate    PrioritateTichet @default(NORMALA)
  status        StatusTichet     @default(DESCHIS)

  // Imagini atașate
  imagini       String[]         // URLs

  // Localizare opțională
  locatie       String?          // "Scara A, etaj 3" sau "Parcare subterană"

  // Timestamps
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  rezolvatLa    DateTime?

  // Relations
  asociatieId   String
  asociatie     Asociatie        @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  creatorId     String
  creator       User             @relation("TicheteCreate", fields: [creatorId], references: [id])

  asignatId     String?
  asignat       User?            @relation("TicheteAsignate", fields: [asignatId], references: [id])

  comentarii    ComentariuTichet[]

  @@map("tichete")
}

model ComentariuTichet {
  id          String   @id @default(cuid())
  continut    String   @db.Text
  esteIntern  Boolean  @default(false)  // Comentariu doar pentru admin

  tichetId    String
  tichet      Tichet   @relation(fields: [tichetId], references: [id], onDelete: Cascade)

  autorId     String
  autor       User     @relation(fields: [autorId], references: [id])

  createdAt   DateTime @default(now())

  @@map("comentarii_tichete")
}

// ============================================
// CONTURI BANCARE & PLATI BANCARE
// ============================================

model ContBancarAsociatie {
  id           String   @id @default(cuid())
  nume         String   // "Cont BT Principal", "Cont ING Cheltuieli"
  iban         String
  banca        String   // "Banca Transilvania", "ING Bank"
  codBic       String?  // BIC/SWIFT code
  esteImplicit Boolean  @default(false)

  asociatieId  String
  asociatie    Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  platiPending PlataBancaraPending[]

  createdAt    DateTime @default(now())

  @@map("conturi_bancare_asociatie")
}

enum StatusPlataBancara {
  PENDING     // In asteptare export
  EXPORTED    // Exportat in fisier
  PAID        // Confirmat platit
}

model PlataBancaraPending {
  id                String   @id @default(cuid())

  // Beneficiary (furnizor)
  beneficiarNume    String
  beneficiarIban    String
  beneficiarBanca   String?
  beneficiarCui     String?

  suma              Float
  descriere         String   // Payment description
  referinta         String?  // Reference for the payment

  // Source bank account
  contBancarId      String
  contBancar        ContBancarAsociatie @relation(fields: [contBancarId], references: [id])

  // Link to expense
  cheltuialaId      String?

  // Status
  status            StatusPlataBancara @default(PENDING)
  exportedAt        DateTime?
  paidAt            DateTime?

  asociatieId       String
  asociatie         Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())

  @@map("plati_bancare_pending")
}

// ============================================
// AI AGENTS
// ============================================

enum AgentType {
  OCR_FACTURA       // Extrage date din facturi
  OCR_INDEX         // Citeste indexuri contoare
  CALCUL_CHITANTA   // Genereaza chitante
  PREDICTIE_PLATA   // Prezice restante
  CHATBOT           // Raspunde la intrebari
  RECONCILIERE      // Match plati cu chitante
  REMINDER          // Trimite remindere
  RAPORT            // Genereaza rapoarte
}

model AgentLog {
  id          String    @id @default(cuid())
  agentType   AgentType
  input       String    @db.Text
  output      String    @db.Text
  success     Boolean
  errorMsg    String?
  durationMs  Int
  tokensUsed  Int?
  cost        Float?    // in USD

  asociatieId String?
  asociatie   Asociatie? @relation(fields: [asociatieId], references: [id])

  userId      String?
  user        User?      @relation(fields: [userId], references: [id])

  createdAt   DateTime  @default(now())

  @@map("agent_logs")
}

model PredictieRestanta {
  id              String   @id @default(cuid())
  apartamentId    String
  luna            Int
  an              Int

  probabilitate   Float    // 0-100
  sumaEstimata    Float
  factori         String   @db.Text // JSON

  asociatieId     String
  asociatie       Asociatie @relation(fields: [asociatieId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([asociatieId, apartamentId, luna, an])
  @@map("predictii_restante")
}
